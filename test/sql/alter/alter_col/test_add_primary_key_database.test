# name: test/sql/alter/alter_col/test_add_primary_key_database.test
# description: Test ALTER TABLE table ADD PRIMARY KEY (column)
# group: [alter_col]

load __TEST_DIR__/test_add_primary_key.db

statement ok
PRAGMA enable_verification

# Scenario #1: test storage of primary keys
statement ok
CREATE TABLE test1 (i INTEGER, j INTEGER)

statement ok
ALTER TABLE test1 ADD PRIMARY KEY (j)

statement ok
INSERT INTO test1 VALUES (1, 1)

restart

statement error
ALTER TABLE test1 ADD PRIMARY KEY (i)
----
Catalog Error: table "test1" can have only one primary key, and already has PRIMARY KEY(j).

statement error
INSERT INTO test1 VALUES (2, 1)
----
Constraint Error: Duplicate key "j: 1" violates primary key constraint.

# Scenario #2: test detach/reattach
statement ok
ATTACH ':memory:' as memory

statement ok
USE memory

statement ok
DETACH test_add_primary_key

statement ok
ATTACH '__TEST_DIR__/test_add_primary_key.db' as test_add_primary_key

statement ok
USE test_add_primary_key

statement error
ALTER TABLE test1 ADD PRIMARY KEY (i)
----
Catalog Error: table "test1" can have only one primary key, and already has PRIMARY KEY(j).

statement error
INSERT INTO test1 VALUES (2, 1)
----
Constraint Error: Duplicate key "j: 1" violates primary key constraint.

# Scenario #3: drop and re-create table (pk should not be persisted)
statement ok
CREATE TABLE test3 (i INTEGER, j INTEGER)

statement ok
ALTER TABLE test3 ADD PRIMARY KEY (j)

statement ok
INSERT INTO test3 VALUES (1, 1)

statement ok
DROP TABLE test3

statement ok
CREATE TABLE test3 (i INTEGER, j INTEGER)

statement ok
INSERT INTO test3 VALUES (1, 1)

statement ok
ALTER TABLE test3 ADD PRIMARY KEY (j)

