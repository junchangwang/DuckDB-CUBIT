# name: test/sql/alter/alter_col/test_add_primary_key.test
# description: Test ALTER TABLE table ADD PRIMARY KEY (column)
# group: [alter_col]

statement ok
PRAGMA enable_verification

# Scenario #1: single column pk
statement ok
CREATE TABLE test1 (i INTEGER, j INTEGER)

statement ok
INSERT INTO test1 VALUES (1, 1)

statement ok
ALTER TABLE test1 ADD PRIMARY KEY (j)

# Check data is preserved
query II
SELECT * FROM test1
----
1	1

statement ok
INSERT INTO test1 VALUES (1, 2)

statement error
INSERT INTO test1 VALUES (2, 1)
----
Duplicate key "j: 1" violates primary key constraint

statement error
INSERT INTO test1 VALUES (2, NULL)
----
NOT NULL constraint failed: test1.j

# altering a second time should fail, only one pk is allowed per table
statement error
ALTER TABLE test1 ADD PRIMARY KEY (i)
----
Catalog Error: table "test1" can have only one primary key, and already has PRIMARY KEY(j).

# even if it's an exact duplicate
statement error
ALTER TABLE test1 ADD PRIMARY KEY (j)
----
Catalog Error: table "test1" can have only one primary key, and already has PRIMARY KEY(j).

# Scenario #2: multiple column pk
statement ok
CREATE TABLE test2 (i INTEGER, j INTEGER, d TEXT)

statement ok
ALTER TABLE test2 ADD PRIMARY KEY (i, j)

statement ok
INSERT INTO test2 VALUES (1, 1, 'foo')

statement ok
INSERT INTO test2 VALUES (1, 2, 'bar')

statement error
INSERT INTO test2 VALUES (1, 2, 'oops')
----
Duplicate key "i: 1, j: 2" violates primary key constraint

statement error
INSERT INTO test2 VALUES (NULL, 2, 'nada')
----
NOT NULL constraint failed: test2.i

# Scenario #3: primary key already exists
statement ok
CREATE TABLE test3 (i INTEGER PRIMARY KEY, j INTEGER)

statement error
ALTER TABLE test3 ADD PRIMARY KEY (i, j)
----
Catalog Error: table "test3" can have only one primary key, and already has PRIMARY KEY(i).

# Scenario #4: column does not exist
statement ok
CREATE TABLE test4 (i INTEGER, j INTEGER)

statement error
ALTER TABLE test4 ADD PRIMARY KEY (i_do_not_exist)
----
Table "test4" does not have a column named "i_do_not_exist"

# Scenario #5: table does not exist
statement error
ALTER TABLE i_do_not_exist ADD PRIMARY KEY (i, j)
----
Table with name i_do_not_exist does not exist!

# Scenario #6: add pk to table containing data invalidating the constraint (this should fail)
statement ok
CREATE TABLE test6 (i INTEGER, j INTEGER)

statement ok
INSERT INTO test6 VALUES (1, 10), (2, 20), (3, 30), (1, 100), (NULL, 0)

statement error
ALTER TABLE test6 ADD PRIMARY KEY (i)
----
PRIMARY KEY or UNIQUE constraint violated: duplicate key "1"

# Scenario #7: test with non-consecutive row ids
statement ok
CREATE TABLE integers(i integer)

statement ok
INSERT INTO integers SELECT * FROM range(50000);

query I
SELECT i FROM integers WHERE i = 100
----
100

statement ok
DELETE FROM integers WHERE i = 42;

statement ok
ALTER TABLE integers ADD PRIMARY KEY (i);

query I
SELECT i FROM integers WHERE i = 100
----
100

# Scenario #8: Add primary key to column with already a unique index on it
statement ok
CREATE TABLE test8 (i INTEGER UNIQUE, j INTEGER)

statement ok
INSERT INTO test8 VALUES (1, 10), (2, 20), (3, 30)

statement error
INSERT INTO test8 VALUES (1, 100)
----
Constraint Error: Duplicate key "i: 1" violates unique constraint.

statement ok
INSERT INTO test8 VALUES (NULL, 100)

statement ok
ALTER TABLE test8 ADD PRIMARY KEY (i)

statement error
INSERT INTO test8 VALUES (1, 101)
----
Constraint Error: Duplicate key "i: 1" violates primary key constraint.

statement error
INSERT INTO test8 VALUES (NULL, 100)
----
Constraint Error: NOT NULL constraint failed: test8.i

# Scenario #9: reverse column order in index
statement ok
CREATE TABLE test9 (i INTEGER, j INTEGER)

statement ok
INSERT INTO test9 VALUES (1, 2)

statement ok
ALTER TABLE test9 ADD PRIMARY KEY (j, i)

statement error
INSERT INTO test9 VALUES (1, 2)
----
Duplicate key "j: 2, i: 1" violates primary key constraint.

statement error
INSERT INTO test9 (j, i) VALUES (2, 1)
----
Duplicate key "j: 2, i: 1" violates primary key constraint.

# Scenario #10: invalid primary key type
statement ok
CREATE TABLE test10 (a INTEGER[], b INTEGER)

statement error
ALTER TABLE test10 ADD PRIMARY KEY (a)
----
Invalid type Error: Invalid Type [INTEGER[]]: Invalid type for index key.

statement error
ALTER TABLE test10 ADD PRIMARY KEY (a, b)
----
Invalid type Error: Invalid Type [INTEGER[]]: Invalid type for index key.

# Scenario #11: After adding a primary key to an existing table, verify index is correct
statement ok
CREATE TABLE test11 (i INTEGER, j INTEGER)

statement ok
INSERT INTO test11 VALUES (4, 40), (1, 10), (3, 30), (2, 20), (5, 50)

statement ok
ALTER TABLE test11 ADD PRIMARY KEY (i)

query II
SELECT * FROM test11 WHERE i = 2
----
2	20
